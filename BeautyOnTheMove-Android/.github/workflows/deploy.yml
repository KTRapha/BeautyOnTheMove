name: Deploy to AWS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  S3_BUCKET: botm-deploy-665802315326-us-east-1
  CODEPLOY_APPLICATION: BeautyOnTheMoveApp
  CODEPLOY_DEPLOYMENT_GROUP: BeautyOnTheMoveDeploymentGroupWithoutBoundary

permissions:
  id-token: write
  contents: read

jobs:
  test-aws-connection:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.IAMROLE_GITHUB }}
          role-session-name: GitHubActions
          aws-region: us-east-1

      - name: Test AWS connection
        run: |
          set -e
          echo "ğŸ” Testing AWS connection..."
          aws sts get-caller-identity
          echo "âœ… AWS connection successful!"

      - name: Test CodeDeploy access
        run: |
          set -e
          echo "ğŸ” Testing CodeDeploy access..."
          aws deploy list-applications
          echo "âœ… CodeDeploy access successful!"

      - name: Test S3 access
        run: |
          set -e
          echo "ğŸ” Testing S3 access..."
          aws s3 ls
          echo "âœ… S3 access successful!"

      - name: Test specific S3 bucket access
        run: |
          set -e
          echo "ğŸ” Testing specific S3 bucket access..."
          aws s3 ls s3://ktrapha-beautyonmove-android-deployments || { echo "âŒ Bucket not found or no access"; exit 1; }
          echo "âœ… S3 bucket test completed!"

  build-and-deploy:
    needs: test-aws-connection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.IAMROLE_GITHUB }}
          role-session-name: GitHubActions
          aws-region: us-east-1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '11'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install dependencies
        run: |
          set -e
          cd ..
          echo "ğŸ“¦ Installing npm dependencies..."
          npm install
          echo "âœ… Dependencies installed successfully!"

      - name: Fix Gradle wrapper permissions
        run: |
          set -e
          cd ..
          echo "ğŸ”§ Fixing Gradle wrapper permissions..."
          
          # Check if gradlew exists in android directory
          if [ -f "android/gradlew" ]; then
            echo "âœ… Found gradlew in android/gradlew"
            chmod +x android/gradlew
            echo "âœ… Gradle wrapper permissions fixed!"
          elif [ -f "gradlew" ]; then
            echo "âœ… Found gradlew in root directory"
            chmod +x gradlew
            echo "âœ… Gradle wrapper permissions fixed!"
          else
            echo "âŒ gradlew not found in expected locations"
            echo "Searching for gradlew files..."
            find . -name "gradlew" -type f
            exit 1
          fi

      - name: Build Android app
        run: |
          set -e
          cd ..
          echo "ğŸ”¨ Building Android app..."
          
          # Set Android environment variables
          export ANDROID_HOME=$ANDROID_SDK_ROOT
          export PATH=$PATH:$ANDROID_HOME/emulator
          export PATH=$PATH:$ANDROID_HOME/tools
          export PATH=$PATH:$ANDROID_HOME/tools/bin
          export PATH=$PATH:$ANDROID_HOME/platform-tools
          
          # Fix line endings in gradle files
          echo "ğŸ”„ Fixing line endings in gradle files..."
          find android -name "*.gradle" -exec sed -i 's/\r$//' {} \;
          find android -name "*.properties" -exec sed -i 's/\r$//' {} \;
          
          # Build using gradle
          echo "ğŸ—ï¸ Building with Gradle..."
          cd android
          
          # Fix gradlew permissions FROM THE ANDROID DIRECTORY
          echo "ğŸ”§ Fixing gradlew permissions..."
          chmod +x ./gradlew
          echo "âœ… Gradlew permissions fixed!"
          
          # Verify gradlew is executable
          ls -la ./gradlew
          
          # Now run gradle commands
          echo "ğŸ§¹ Running gradle clean..."
          ./gradlew clean
          echo "ğŸ—ï¸ Running gradle assembleRelease..."
          ./gradlew assembleRelease
          cd ..
          
          echo "ğŸ” Checking for APK files..."
          find . -name "*.apk" -type f || { echo "âŒ No APK files found"; exit 1; }
          echo "âœ… Build completed successfully!"

      - name: Debug - Check current directory and files
        run: |
          set -e
          echo "=== Current directory ==="
          pwd
          echo "=== Directory contents ==="
          ls -la
          echo "=== AWS scripts directory ==="
          ls -la aws/scripts/ || { echo "âŒ aws/scripts/ not found"; exit 1; }

      - name: Create deployment package
        run: |
          set -e
          echo "ğŸ“ Creating deployment directory..."
          mkdir -p deployment
          
          echo "ğŸ“¦ Copying APK files..."
          cp -r ../android/app/build/outputs/apk/release/* deployment/ || { echo "âŒ No APK files found"; exit 1; }
          
          echo "ğŸ“„ Copying appspec.yml..."
          cp appspec.yml deployment/
          
          echo "ğŸ“œ Copying scripts..."
          cp -r aws/scripts deployment/
          
          echo "ğŸ“‹ Deployment directory contents:"
          ls -la deployment/
          echo "ğŸ“‹ Scripts directory contents:"
          ls -la deployment/scripts/

      - name: Fix script permissions and line endings
        run: |
          set -e
          cd deployment
          echo "ğŸ”§ Current directory: $(pwd)"
          
          echo "ğŸ”§ Fixing script permissions and line endings..."
          
          # Check if scripts exist
          if [ ! -d "scripts" ]; then
            echo "âŒ ERROR: scripts directory not found!"
            exit 1
          fi
          
          # List scripts before processing
          echo "ğŸ“‹ Scripts before processing:"
          ls -la scripts/
          
          # Convert Windows line endings to Unix (CRLF to LF) using tr
          echo "ğŸ”„ Using tr to fix line endings..."
          for script in scripts/*.sh; do
            echo "Converting line endings for $script..."
            tr -d '\r' < "$script" > "${script}.tmp" && mv "${script}.tmp" "$script"
          done
          
          # Make scripts executable
          echo "ğŸ” Making scripts executable..."
          chmod +x scripts/*.sh
          
          # Verify scripts are executable and have correct line endings
          echo "âœ… Verifying scripts..."
          ls -la scripts/
          echo "ğŸ“„ Checking script contents (first few lines):"
          for script in scripts/*.sh; do
            echo "=== $script ==="
            head -5 "$script"
            echo "=== End of $script ==="
          done
          
          # Test script execution
          echo "ğŸ§ª Testing script execution..."
          for script in scripts/*.sh; do
            echo "Testing $script..."
            bash -n "$script" && echo "âœ… $script syntax OK" || { echo "âŒ $script syntax error"; exit 1; }
          done

      - name: Debug - Check final deployment package
        run: |
          set -e
          cd deployment
          echo "ğŸ“‹ Final deployment package contents:"
          find . -type f -exec ls -la {} \;
          echo "ğŸ“‹ Script permissions:"
          ls -la scripts/

      - name: Upload to S3
        run: |
          set -e
          echo "â˜ï¸ Uploading to S3..."
          aws s3 cp deployment/ s3://ktrapha-beautyonmove-android-deployments/ --recursive
          echo "âœ… Upload completed successfully!"

      - name: Deploy to CodeDeploy
        run: |
          set -e
          echo "ğŸš€ Deploying to CodeDeploy..."
          aws deploy create-deployment \
            --application-name BeautyOnTheMoveApp \
            --deployment-group-name BeautyOnTheMoveDeploymentGroupWithoutBoundary \
            --s3-location bucket=ktrapha-beautyonmove-android-deployments,key=appspec.yml,bundleType=YAML \
            --deployment-config-name CodeDeployDefault.OneAtATime
          echo "âœ… Deployment initiated successfully!"

      - name: Wait for deployment
        run: |
          set -e
          echo "â³ Waiting for deployment to complete..."
          # This is a simplified wait - in production you'd want to check deployment status
          sleep 30
          echo "âœ… Deployment wait completed!" 