name: Deploy to AWS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  S3_BUCKET: botm-deploy-665802315326-us-east-1
  CODEPLOY_APPLICATION: BeautyOnTheMoveApp
  CODEPLOY_DEPLOYMENT_GROUP: BeautyOnTheMoveDeploymentGroupWithoutBoundary

permissions:
  id-token: write
  contents: read

jobs:
  test-aws-connection:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.IAMROLE_GITHUB }}
          role-session-name: GitHubActions
          aws-region: us-east-1

      - name: Test AWS connection
        run: |
          set -e
          echo "ğŸ” Testing AWS connection..."
          aws sts get-caller-identity
          echo "âœ… AWS connection successful!"

      - name: Test CodeDeploy access
        run: |
          set -e
          echo "ğŸ” Testing CodeDeploy access..."
          aws deploy list-applications
          echo "âœ… CodeDeploy access successful!"

      - name: Test S3 access
        run: |
          set -e
          echo "ğŸ” Testing S3 access..."
          aws s3 ls
          echo "âœ… S3 access successful!"

      - name: Test specific S3 bucket access
        run: |
          set -e
          echo "ğŸ” Testing specific S3 bucket access..."
          aws s3 ls s3://ktrapha-beautyonmove-android-deployments || { echo "âŒ Bucket not found or no access"; exit 1; }
          echo "âœ… S3 bucket test completed!"

  build-and-deploy:
    needs: test-aws-connection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.IAMROLE_GITHUB }}
          role-session-name: GitHubActions
          aws-region: us-east-1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          set -e
          cd ..
          echo "ğŸ“¦ Installing npm dependencies..."
          npm install
          echo "âœ… Dependencies installed successfully!"

      - name: Build Android app
        run: |
          set -e
          cd ..
          echo "ğŸ”¨ Building Android app..."
          # Try different build approaches
          if command -v npx >/dev/null 2>&1; then
            echo "Using npx react-native..."
            npx react-native build-android --mode=release
          else
            echo "npx not available, trying direct gradle..."
            cd android && ./gradlew assembleRelease
          fi
          
          echo "ğŸ” Checking for APK files..."
          find . -name "*.apk" -type f || { echo "âŒ No APK files found"; exit 1; }
          echo "âœ… Build completed successfully!"

      - name: Debug - Check current directory and files
        run: |
          set -e
          echo "=== Current directory ==="
          pwd
          echo "=== Directory contents ==="
          ls -la
          echo "=== AWS scripts directory ==="
          ls -la aws/scripts/ || { echo "âŒ aws/scripts/ not found"; exit 1; }

      - name: Create deployment package
        run: |
          set -e
          echo "ğŸ“ Creating deployment directory..."
          mkdir -p deployment
          
          echo "ğŸ“¦ Copying APK files..."
          cp -r ../android/app/build/outputs/apk/release/* deployment/ || { echo "âŒ No APK files found"; exit 1; }
          
          echo "ğŸ“„ Copying appspec.yml..."
          cp appspec.yml deployment/
          
          echo "ğŸ“œ Copying scripts..."
          cp -r aws/scripts deployment/
          
          echo "ğŸ“‹ Deployment directory contents:"
          ls -la deployment/
          echo "ğŸ“‹ Scripts directory contents:"
          ls -la deployment/scripts/

      - name: Fix script permissions and line endings
        run: |
          set -e
          cd deployment
          echo "ğŸ”§ Current directory: $(pwd)"
          echo "ğŸ“¦ Installing dos2unix for line ending conversion..."
          sudo apt-get update
          sudo apt-get install -y dos2unix
          
          echo "ğŸ”§ Fixing script permissions and line endings..."
          
          # Check if scripts exist
          if [ ! -d "scripts" ]; then
            echo "âŒ ERROR: scripts directory not found!"
            exit 1
          fi
          
          # List scripts before processing
          echo "ğŸ“‹ Scripts before processing:"
          ls -la scripts/
          
          # Convert Windows line endings to Unix (CRLF to LF)
          echo "ğŸ”„ Using dos2unix to fix line endings..."
          dos2unix scripts/*.sh
          
          # Make scripts executable
          echo "ğŸ” Making scripts executable..."
          chmod +x scripts/*.sh
          
          # Verify scripts are executable and have correct line endings
          echo "âœ… Verifying scripts..."
          ls -la scripts/
          echo "ğŸ“„ Checking script contents (first few lines):"
          for script in scripts/*.sh; do
            echo "=== $script ==="
            head -5 "$script"
            echo "=== End of $script ==="
          done
          
          # Test script execution
          echo "ğŸ§ª Testing script execution..."
          for script in scripts/*.sh; do
            echo "Testing $script..."
            bash -n "$script" && echo "âœ… $script syntax OK" || { echo "âŒ $script syntax error"; exit 1; }
          done

      - name: Debug - Check final deployment package
        run: |
          set -e
          cd deployment
          echo "ğŸ“‹ Final deployment package contents:"
          find . -type f -exec ls -la {} \;
          echo "ğŸ“‹ Script permissions:"
          ls -la scripts/

      - name: Upload to S3
        run: |
          set -e
          echo "â˜ï¸ Uploading to S3..."
          aws s3 cp deployment/ s3://ktrapha-beautyonmove-android-deployments/ --recursive
          echo "âœ… Upload completed successfully!"

      - name: Deploy to CodeDeploy
        run: |
          set -e
          echo "ğŸš€ Deploying to CodeDeploy..."
          aws deploy create-deployment \
            --application-name BeautyOnTheMoveApp \
            --deployment-group-name BeautyOnTheMoveDeploymentGroupWithoutBoundary \
            --s3-location bucket=ktrapha-beautyonmove-android-deployments,key=appspec.yml,bundleType=YAML \
            --deployment-config-name CodeDeployDefault.OneAtATime
          echo "âœ… Deployment initiated successfully!"

      - name: Wait for deployment
        run: |
          set -e
          echo "â³ Waiting for deployment to complete..."
          # This is a simplified wait - in production you'd want to check deployment status
          sleep 30
          echo "âœ… Deployment wait completed!" 