name: Deploy to AWS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  S3_BUCKET: botm-deploy-665802315326-us-east-1
  CODEPLOY_APPLICATION: BeautyOnTheMoveApp
  CODEPLOY_DEPLOYMENT_GROUP: BeautyOnTheMoveDeploymentGroupWithoutBoundary

permissions:
  id-token: write
  contents: read

jobs:
  test-aws-connection:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.IAMROLE_GITHUB }}
          role-session-name: GitHubActions
          aws-region: us-east-1

      - name: Test AWS connection
        run: |
          echo "Testing AWS connection..."
          aws sts get-caller-identity
          echo "AWS connection successful!"

  build-and-deploy:
    needs: test-aws-connection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.IAMROLE_GITHUB }}
          role-session-name: GitHubActions
          aws-region: us-east-1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          cd ..
          npm install

      - name: Build Android app
        run: |
          cd ..
          npx react-native build-android --mode=release

      - name: Create deployment package
        run: |
          mkdir -p deployment
          cp -r ../android/app/build/outputs/apk/release/* deployment/
          cp appspec.yml deployment/
          cp -r aws/scripts deployment/

      - name: Fix script permissions and line endings
        run: |
          cd deployment
          chmod +x scripts/*.sh
          # Convert Windows line endings to Unix
          if command -v dos2unix >/dev/null 2>&1; then
            dos2unix scripts/*.sh
          else
            # Fallback: use sed to remove carriage returns
            sed -i 's/\r$//' scripts/*.sh
          fi

      - name: Upload to S3
        run: |
          aws s3 cp deployment/ s3://ktrapha-beautyonmove-android-deployments/ --recursive

      - name: Deploy to CodeDeploy
        run: |
          aws deploy create-deployment \
            --application-name BeautyOnTheMoveApp \
            --deployment-group-name BeautyOnTheMoveDeploymentGroupWithoutBoundary \
            --s3-location bucket=ktrapha-beautyonmove-android-deployments,key=appspec.yml,bundleType=YAML \
            --deployment-config-name CodeDeployDefault.OneAtATime

      - name: Wait for deployment
        run: |
          echo "Waiting for deployment to complete..."
          # This is a simplified wait - in production you'd want to check deployment status
          sleep 30 